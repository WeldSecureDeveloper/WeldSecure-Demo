
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Outlook Inbox Mock</title>
    <style>
      :root {
        font-family: "Segoe UI", "Helvetica Neue", system-ui, -apple-system, sans-serif;
        color: #1a2538;
        --blue-900: #0b61c5;
        --blue-700: #2b74c8;
        --blue-100: #e4efff;
        --border: #d0d6df;
        --border-light: #e9edf3;
        --gray-25: #fcfdff;
        --gray-50: #f7f8fb;
        --gray-100: #eff2f7;
        --gray-400: #a2a9b7;
        --gray-600: #5c6474;
        --gray-800: #323b4c;
        --sidebar-width: 230px;
        --list-width: 300px;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--gray-100);
      }

      body.compact-rows .message-row {
        padding: 0.5rem 0.85rem;
      }

      body.hide-snippets .message-row__preview {
        display: none;
      }

      body.focus-reading .reading-pane {
        box-shadow: inset 0 0 0 2px rgba(11, 97, 197, 0.15);
      }

      body.modal-open {
        overflow: hidden;
      }

      button {
        font: inherit;
        cursor: pointer;
      }

      [hidden] {
        display: none !important;
      }

      .outlook-window {
        min-height: 100vh;
        background: #fff;
        display: flex;
        flex-direction: column;
        box-shadow: 0 16px 60px rgba(24, 38, 71, 0.2);
      }

      .outlook-topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1.5rem;
        background: linear-gradient(90deg, var(--blue-900), #1773cf 55%, #2b84df);
        color: #fff;
        min-height: 56px;
      }

      .topbar-left {
        display: flex;
        align-items: center;
        gap: 1.25rem;
      }

      .logo-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.65rem;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.14);
        font-weight: 600;
      }

      .logo-chip span:first-child {
        width: 26px;
        height: 26px;
        border-radius: 4px;
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.18);
      }

      .topbar-search {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 999px;
        padding: 0.3rem 0.85rem;
        min-width: 220px;
      }

      .topbar-search input {
        border: none;
        background: transparent;
        color: inherit;
        outline: none;
      }

      .topbar-icons {
        display: flex;
        gap: 0.4rem;
      }

      .topbar-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: none;
        background: rgba(255, 255, 255, 0.18);
        color: inherit;
        display: grid;
        place-items: center;
      }

      .outlook-ribbon {
        background: #f6f7fa;
        border-bottom: 1px solid var(--border);
        padding: 0.5rem 1.5rem 0.75rem;
      }

      .ribbon-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.4rem;
      }

      .ribbon-tabs button {
        border: none;
        background: transparent;
        font-weight: 600;
        color: var(--gray-600);
        padding-bottom: 0.25rem;
        border-bottom: 2px solid transparent;
      }

      .ribbon-tabs button.is-active {
        border-color: var(--blue-900);
        color: var(--blue-900);
      }

      .ribbon-groups {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .ribbon-button {
        border: 1px solid var(--border);
        border-radius: 6px;
        background: #fff;
        padding: 0.4rem 0.65rem;
        min-width: 70px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        color: var(--gray-700);
      }

      .outlook-main {
        flex: 1;
        display: grid;
        grid-template-columns: var(--sidebar-width) var(--list-width) 1fr;
        min-height: 0;
      }
      .sidebar {
        border-right: 1px solid var(--border);
        background: var(--gray-50);
        padding: 1rem 0.75rem 1rem 1rem;
        overflow-y: auto;
      }

      .sidebar h3 {
        margin: 1.25rem 0 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-size: 0.8rem;
        color: var(--gray-600);
      }

      .folder-button {
        width: 100%;
        border: none;
        background: transparent;
        padding: 0.45rem 0.35rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 6px;
      }

      .folder-button.is-active {
        background: rgba(11, 97, 197, 0.13);
        color: var(--blue-900);
        font-weight: 600;
      }

      .badge {
        background: var(--blue-900);
        color: #fff;
        border-radius: 999px;
        font-size: 0.75rem;
        padding: 0 0.5rem;
        min-width: 24px;
        text-align: center;
      }

      .message-column {
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
      }

      .message-toolbar {
        border-bottom: 1px solid var(--border);
        padding: 0.6rem 1rem;
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
      }

      .message-list {
        flex: 1;
        overflow-y: auto;
      }

      .message-group {
        padding: 0.85rem 1rem 0.35rem;
        text-transform: uppercase;
        font-size: 0.74rem;
        color: var(--gray-600);
        font-weight: 600;
      }

      .message-rows {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .message-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.4rem;
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--border-light);
        cursor: pointer;
      }

      .message-row:hover {
        background: #f1f5fb;
      }

      .message-row.is-active {
        background: var(--blue-100);
        border-left: 3px solid var(--blue-900);
        padding-left: calc(1rem - 3px);
      }

      .message-row.is-unread .message-row__subject {
        font-weight: 700;
      }

      .message-row.is-unread .message-row__time {
        color: var(--blue-900);
        font-weight: 600;
      }

      .message-row__subject {
        font-weight: 600;
      }

      .message-row__sender,
      .message-row__time,
      .message-row__preview {
        font-size: 0.85rem;
        color: var(--gray-600);
      }

      .message-row__preview {
        grid-column: 1 / span 2;
      }

      .reading-pane {
        display: flex;
        flex-direction: column;
      }

      .reading-header {
        border-bottom: 1px solid var(--border);
        padding: 1rem 1.5rem 0.5rem;
      }

      .reading-subject {
        margin: 0 0 0.4rem;
        font-size: 1.45rem;
      }

      .reading-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: var(--gray-600);
      }

      .reading-sender {
        margin-top: 0.85rem;
        display: flex;
        gap: 0.75rem;
        align-items: center;
        padding-bottom: 0.85rem;
        border-bottom: 1px solid var(--border-light);
      }

      .avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: #1f2440;
        color: #fff;
        display: grid;
        place-items: center;
        font-weight: 600;
      }

      .sender-meta {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
      }

      .sender-meta span {
        color: var(--gray-600);
        font-size: 0.85rem;
      }

      .reading-body {
        padding: 1.25rem 1.5rem 2rem;
        overflow-y: auto;
      }

      .reading-body p {
        margin: 0 0 0.9rem;
        line-height: 1.5;
      }

      .status-bar {
        border-top: 1px solid var(--border);
        padding: 0.4rem 1rem;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        justify-content: space-between;
        flex-wrap: wrap;
        background: #f6f7fa;
      }

      .identity-chip {
        border: 1px solid var(--border);
        background: #fff;
        border-radius: 999px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.2rem 0.8rem 0.2rem 0.3rem;
        color: inherit;
      }

      .identity-chip__avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--blue-900);
        color: #fff;
        display: grid;
        place-items: center;
        font-weight: 600;
      }

      .identity-chip__meta {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
      }

      .identity-chip__meta strong {
        font-size: 0.9rem;
      }

      .identity-chip__meta small {
        font-size: 0.7rem;
        color: var(--gray-600);
      }

      .identity-chip__chevron {
        font-size: 0.85rem;
        color: var(--gray-600);
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(17, 25, 40, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        z-index: 20;
      }

      .modal__dialog {
        background: #fff;
        width: min(520px, 100%);
        border-radius: 18px;
        border: 1px solid var(--border);
        box-shadow: 0 30px 80px rgba(19, 30, 58, 0.35);
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 3rem);
      }

      .modal header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal header h2 {
        margin: 0;
        font-size: 1.1rem;
      }

      .modal__body {
        padding: 1rem 1.25rem;
        overflow-y: auto;
      }

      .user-option {
        width: 100%;
        border: 1px solid transparent;
        border-radius: 12px;
        padding: 0.75rem;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
      }

      .user-option:hover,
      .user-option.is-active {
        border-color: var(--blue-900);
        background: var(--blue-100);
      }

      .settings-option {
        display: flex;
        gap: 0.75rem;
        border: 1px solid var(--border-light);
        padding: 0.9rem;
        border-radius: 12px;
        align-items: flex-start;
        background: var(--gray-25);
      }

      @media (max-width: 1200px) {
        .outlook-main {
          grid-template-columns: var(--sidebar-width) var(--list-width) 1fr;
        }
      }

      @media (max-width: 900px) {
        .outlook-main {
          grid-template-columns: 1fr;
        }

        .sidebar {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="outlook-window">
      <header class="outlook-topbar">
        <div class="topbar-left">
          <div class="logo-chip">
            <span>O</span>
            <span>Outlook</span>
          </div>
          <span class="topbar-route">Mail &gt; Sandbox inbox</span>
        </div>
        <div class="topbar-right">
          <div class="topbar-search">
            <span aria-hidden="true">🔍</span>
            <input type="search" placeholder="Search mail and people" />
          </div>
          <div class="topbar-icons">
            <button class="topbar-icon" title="New message">✉️</button>
            <button class="topbar-icon" title="Calendar">📅</button>
            <button
              class="topbar-icon"
              id="settings-toggle"
              aria-expanded="false"
              aria-controls="settings-panel"
              title="Inbox settings"
            >
              ⚙️
            </button>
          </div>
        </div>
      </header>
      <section class="outlook-ribbon">
        <div class="ribbon-tabs">
          <button class="is-active">Message</button>
          <button>Home</button>
          <button>View</button>
        </div>
        <div class="ribbon-groups">
          <button class="ribbon-button"><span>✉️</span>New email</button>
          <button class="ribbon-button"><span>📎</span>Attach</button>
          <button class="ribbon-button"><span>🗑️</span>Delete</button>
          <button class="ribbon-button"><span>🚩</span>Follow up</button>
        </div>
      </section>

      <div class="outlook-main">
        <aside class="sidebar">
          <h3>Favorites</h3>
          <button class="folder-button is-active">
            <span>Inbox</span>
            <span class="badge" id="inbox-unread">1</span>
          </button>
          <button class="folder-button">Sent Items</button>
          <button class="folder-button">Drafts</button>
          <button class="folder-button">Archive</button>

          <h3>Folders</h3>
          <button class="folder-button">Approvals</button>
          <button class="folder-button">Programs</button>
          <button class="folder-button">Teams sync</button>
        </aside>

        <section class="message-column">
          <div class="message-toolbar">
            <span>Arrange By: <strong>Date</strong></span>
            <span>Newest on Top ▾</span>
          </div>
          <div class="message-list" id="message-list" aria-live="polite"></div>
        </section>

        <section class="reading-pane" aria-live="polite">
          <div class="reading-header">
            <h1 class="reading-subject" id="reading-subject">Select a message</h1>
            <div class="reading-meta">
              <span id="reading-date">Pick a message on the left to preview.</span>
              <button class="topbar-icon" style="width:auto;height:auto;color:var(--blue-900);background:transparent;">Manage add-ins…</button>
            </div>
            <div class="reading-sender">
              <div class="avatar" id="reading-avatar">--</div>
              <div class="sender-meta">
                <strong id="reading-sender">Reporter sandbox</strong>
                <span id="reading-sender-role"></span>
                <span id="reading-to"></span>
              </div>
            </div>
          </div>
          <article class="reading-body" id="reading-body">
            <p>Emails become contextual once you choose a reporter identity.</p>
          </article>
        </section>

      </div>

      <div class="status-bar">
        <span id="status-items">Items: 0</span>
        <button class="identity-chip" id="user-picker-trigger" aria-haspopup="dialog">
          <span class="identity-chip__avatar" data-profile-avatar>AR</span>
          <span class="identity-chip__meta">
            <strong data-profile-name>Amelia Reed</strong>
            <small data-profile-role>Director of Treasury Assurance</small>
          </span>
          <span class="identity-chip__chevron">▾</span>
        </button>
        <span id="status-context">Choose a user to hydrate the mailbox.</span>
      </div>
    </div>
    <div class="modal" id="user-picker" hidden>
      <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="user-picker-title">
        <header>
          <h2 id="user-picker-title">Choose a sandbox identity</h2>
          <button type="button" data-close-user-picker aria-label="Close">✕</button>
        </header>
        <div class="modal__body">
          <input
            type="search"
            id="user-picker-filter"
            placeholder="Search by name, role, or department"
            style="width:100%;padding:0.6rem;border-radius:10px;border:1px solid var(--border);margin-bottom:0.85rem;"
          />
          <div id="user-picker-list"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="settings-panel" hidden>
      <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="settings-title">
        <header>
          <h2 id="settings-title">Inbox layout settings</h2>
          <button type="button" data-close-settings aria-label="Close">✕</button>
        </header>
        <div class="modal__body">
          <form class="settings-form" id="settings-form">
            <label class="settings-option">
              <input type="checkbox" name="compactRows" />
              <div>
                <strong>Compact message list</strong>
                <span>Reduce row height for a denser triage queue.</span>
              </div>
            </label>
            <label class="settings-option">
              <input type="checkbox" name="showSnippets" checked />
              <div>
                <strong>Show preview snippets</strong>
                <span>Display the first line of each email beneath the subject.</span>
              </div>
            </label>
            <label class="settings-option">
              <input type="checkbox" name="highlightFocused" checked />
              <div>
                <strong>Emphasize reading pane</strong>
                <span>Add a subtle focus ring when the add-in is docked.</span>
              </div>
            </label>
          </form>
        </div>
      </div>
    </div>

    <script src="../data/directory/orgStructure.js"></script>
    <script src="../data/directory/users.js"></script>
    <script>
      (function () {
        const directory = window.DirectoryData || {};
        const allUsers = Array.isArray(directory.users) ? directory.users.slice() : [];
        if (allUsers.length === 0) {
          allUsers.push({
            id: "sandbox-user",
            displayName: "Sandbox User",
            givenName: "Sandbox",
            surname: "User",
            jobTitle: "Security Analyst",
            departmentId: "security-enablement",
            mail: "sandbox@weldsecure.com",
            officeLocation: "Hybrid",
            licenseStatus: "M365 E5",
            identitySource: "Cloud",
            expertiseTag: "Security enablement",
            teams: []
          });
        }

        const departments = new Map(
          (Array.isArray(directory.departments) ? directory.departments : []).map(dep => [dep.id, dep])
        );
        const preferredUser = allUsers.find(user => user.id === "amelia-reed");
        const fallbackUser = preferredUser || allUsers[0];

        const state = {
          selectedUserId: fallbackUser.id,
          messages: [],
          selectedMessageId: null,
          settings: {
            compactRows: false,
            showSnippets: true,
            highlightFocused: true
          }
        };

        const dom = {
          messageList: document.getElementById("message-list"),
          readingSubject: document.getElementById("reading-subject"),
          readingDate: document.getElementById("reading-date"),
          readingSender: document.getElementById("reading-sender"),
          readingSenderRole: document.getElementById("reading-sender-role"),
          readingTo: document.getElementById("reading-to"),
          readingAvatar: document.getElementById("reading-avatar"),
        readingBody: document.getElementById("reading-body"),
        statusItems: document.getElementById("status-items"),
        statusContext: document.getElementById("status-context"),
        inboxBadge: document.getElementById("inbox-unread"),
        profileName: document.querySelector("[data-profile-name]"),
        profileRole: document.querySelector("[data-profile-role]"),
        profileAvatar: document.querySelector("[data-profile-avatar]"),
        userPicker: document.getElementById("user-picker"),
        userPickerList: document.getElementById("user-picker-list"),
        userPickerFilter: document.getElementById("user-picker-filter"),
          settingsPanel: document.getElementById("settings-panel"),
          settingsToggle: document.getElementById("settings-toggle"),
          settingsForm: document.getElementById("settings-form")
        };

        const playbookRouting = {
          "finance-assurance": "finance",
          "people-experience": "people",
          "engineering-delivery": "engineering",
          "operations-resilience": "operations",
          "security-enablement": "security"
        };

        const scenarioLibrary = {
          finance: [
            {
              id: "treasury",
              subject: ({ department }) => `Treasury exception queue review – ${department.name}`,
              preview: ({ sender, user }) =>
                `${sender.displayName} needs your ${user.jobTitle.toLowerCase()} sign-off before releasing funds.`,
              body: ({ user, sender }) => [
                `Hi ${user.givenName || user.displayName},`,
                "Controls flagged two vendor invoices with mismatched remittance IDs.",
                "Can you skim the worksheet and confirm they follow the treasury guardrails before cut-off?",
                "Thanks,",
                sender.displayName
              ]
            },
            {
              id: "liquidity",
              subject: () => "Liquidity deck talking points",
              preview: ({ sender }) => `${sender.displayName} updated the FX exposure slide.`,
              body: ({ user, sender }) => [
                `Quick nudge ahead of ELT, ${user.givenName || user.displayName}.`,
                "I pulled fresh hedging numbers—can you add your appetite guidance to the notes?",
                "Want the CFO to hear it in your voice.",
                "Appreciate it,",
                sender.displayName
              ]
            },
            {
              id: "automation",
              subject: () => "AP automation pilot checkpoint",
              preview: ({ sender }) => `${sender.displayName} triaged supplier onboarding defects.`,
              body: ({ sender }) => [
                "Power Automate caught another duplicate bank form overnight.",
                "Could you tag any patterns the controls squad should codify?",
                "Your notes always land with the auditors.",
                "Cheers,",
                sender.displayName
              ]
            }
          ],
          people: [
            {
              id: "wellbeing",
              subject: () => "Wellbeing stipend comms",
              preview: ({ sender }) => `${sender.displayName} drafted copy for the stipend reminder.`,
              body: ({ user, sender, department }) => [
                `${department.name} wants to personalize the renewal note for hybrid staff.`,
                `Mind reviewing the copy with your ${user.jobTitle.toLowerCase()} lens?`,
                "Thanks!",
                sender.displayName
              ]
            },
            {
              id: "recognition",
              subject: () => "Recognition drop for ops",
              preview: ({ sender }) => `${sender.displayName} queued shout-outs and needs a quick sanity check.`,
              body: ({ sender }) => [
                "Need your eyes on the talking points before we publish the kudos thread.",
                "Does the tone still match the wellbeing campaign?",
                "Appreciate the quick thumbs-up,",
                sender.displayName
              ]
            },
            {
              id: "onboarding",
              subject: () => "Onboarding kit refresh",
              preview: ({ sender }) => `${sender.displayName} added new Buddy prompts.`,
              body: ({ sender }) => [
                "Sharing the revised week one kit.",
                "If this looks good I'll push to Viva Connections tonight.",
                "Thanks,",
                sender.displayName
              ]
            }
          ],
          engineering: [
            {
              id: "hardening",
              subject: () => "Sprint hardening retro follow-up",
              preview: ({ sender }) => `${sender.displayName} needs your call on gating the release candidate.`,
              body: ({ sender, department }) => [
                "Security testing surfaced the same API regression as last sprint.",
                `Ship behind the flag the ${department.name} guild proposed, or hold the build?`,
                "Need to update the release board before stand-up.",
                "Thanks,",
                sender.displayName
              ]
            },
            {
              id: "runbook",
              subject: () => "Pager duty runbook tweak",
              preview: ({ sender }) => `${sender.displayName} rewired escalation after last night's alert.`,
              body: ({ sender }) => [
                "Mind skimming the diff to ensure it matches the IR deck you own?",
                "Ops is good with it but we want your signature before sharing wider.",
                "Appreciate it,",
                sender.displayName
              ]
            },
            {
              id: "demo",
              subject: () => "Secure demo dry run",
              preview: ({ sender }) => `${sender.displayName} wants to confirm the customer-safe dataset.`,
              body: ({ user, sender }) => [
                "Uploading the latest masked data now.",
                `Give me a thumbs-up once you've validated the rules, ${user.givenName || user.displayName}.`,
                "Need your green light before we invite the customer.",
                "Cheers,",
                sender.displayName
              ]
            }
          ],
          operations: [
            {
              id: "bcp",
              subject: () => "BCP rehearsal logistics",
              preview: ({ sender }) => `${sender.displayName} confirmed facilities access.`,
              body: ({ sender }) => [
                "Attached is the revised rehearsal playbook.",
                "Can you sanity-check supplier comms and make sure we're referencing the right continuity tier?",
                "Thanks,",
                sender.displayName
              ]
            },
            {
              id: "supply",
              subject: () => "Supply route update",
              preview: ({ sender }) => `${sender.displayName} escalated a port delay.`,
              body: ({ user, sender }) => [
                "Need to know if we trigger the alternate route playbook.",
                `Could you weigh in using the ops dashboard you own, ${user.givenName || user.displayName}?`,
                "Happy to sync live if easier.",
                "Cheers,",
                sender.displayName
              ]
            },
            {
              id: "audit",
              subject: () => "Audit evidence for resilience controls",
              preview: ({ sender }) => `${sender.displayName} is packaging docs for regulators.`,
              body: ({ sender }) => [
                "Before I upload this to the portal could you skim the redlines?",
                "I referenced the process maps you refreshed last sprint.",
                "Thanks,",
                sender.displayName
              ]
            }
          ],
          security: [
            {
              id: "incident",
              subject: () => "Incident readiness drill recap",
              preview: ({ sender }) => `${sender.displayName} captured the hotwash notes.`,
              body: ({ user, sender }) => [
                "Great facilitation today.",
                `Dropping the recap so you can plug anything into the exec update, ${user.givenName || user.displayName}.`,
                "Need your call on which lessons learned become part of the runbook.",
                "Thanks,",
                sender.displayName
              ]
            },
            {
              id: "m365",
              subject: () => "M365 hygiene pulse",
              preview: ({ sender }) => `${sender.displayName} spotted a dip in MFA approvals.`,
              body: ({ sender }) => [
                "Numbers dipped below threshold.",
                "Trigger the awareness nudges now or wait another cycle?",
                "Your call—I've queued copy just in case.",
                "Thanks,",
                sender.displayName
              ]
            },
            {
              id: "copilot",
              subject: () => "Copilot rollout guardrails",
              preview: ({ sender }) => `${sender.displayName} needs your approval on the governance FAQ.`,
              body: ({ sender }) => [
                "Sharing the FAQ doc the enablement network drafted.",
                "Can you skim to ensure the exec guidance still lines up with last quarter's rules?",
                "Thanks,",
                sender.displayName
              ]
            }
          ]
        };
        function getSelectedUser() {
          return allUsers.find(user => user.id === state.selectedUserId) || fallbackUser;
        }

        function getDepartment(user) {
          return (user && departments.get(user.departmentId)) || null;
        }

        function getColleagues(user) {
          if (!user) return [];
          return allUsers.filter(candidate => candidate.departmentId === user.departmentId && candidate.id !== user.id);
        }

        function initials(name) {
          if (!name) return "--";
          return name
            .trim()
            .split(/\s+/)
            .slice(0, 2)
            .map(part => part[0])
            .join("")
            .toUpperCase();
        }

        function escapeHtml(value) {
          if (value === null || value === undefined) return "";
          return String(value)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        function formatTimeLabel(date, index) {
          const now = new Date();
          if (date.toDateString() === now.toDateString()) {
            return date.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" });
          }
          if (index === 1) {
            return "Yesterday";
          }
          return date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
        }

        function formatFullDate(date) {
          return date.toLocaleString("en-US", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "numeric",
            minute: "2-digit"
          });
        }

        function buildMailbox(user) {
          const department = getDepartment(user);
          const scenarioKey = playbookRouting[user.departmentId] || "security";
          const templates = scenarioLibrary[scenarioKey] || scenarioLibrary.security;
          const colleagues = getColleagues(user);
          const fallbackSender = colleagues[0] || allUsers.find(candidate => candidate.id !== user.id) || user;
          const now = new Date();
          return templates.map((template, index) => {
            const sender = colleagues[index % Math.max(colleagues.length, 1)] || fallbackSender;
            const received = new Date(now.getTime() - index * 1000 * 60 * 120);
            return {
              id: `${user.id}-${template.id}-${index}`,
              unread: index === 0,
              subject: template.subject({ user, sender, department }),
              preview: template.preview({ user, sender, department }),
              body: template.body({ user, sender, department }),
              senderName: sender.displayName,
              senderTitle: sender.jobTitle,
              toLine: `To: ${user.displayName}`,
              groupLabel: index < 2 ? "Today" : "Earlier this week",
              timeLabel: formatTimeLabel(received, index),
              fullDate: formatFullDate(received)
            };
          });
        }
        function renderMessageList() {
          if (!dom.messageList) return;
          if (state.messages.length === 0) {
            dom.messageList.innerHTML =
              '<div class="message-empty"><p>No messages for this user yet.</p></div>';
            return;
          }

          const grouped = new Map();
          state.messages.forEach(message => {
            if (!grouped.has(message.groupLabel)) {
              grouped.set(message.groupLabel, []);
            }
            grouped.get(message.groupLabel).push(message);
          });

          const markup = Array.from(grouped.entries())
            .map(([label, items]) => {
              const rows = items
                .map(message => {
                  const classes = ["message-row"];
                  if (message.id === state.selectedMessageId) classes.push("is-active");
                  if (message.unread) classes.push("is-unread");
                  return `
                    <li class="${classes.join(" ")}" data-message-id="${escapeHtml(message.id)}">
                      <div>
                        <div class="message-row__subject">${escapeHtml(message.subject)}</div>
                        <div class="message-row__sender">${escapeHtml(message.senderName)}</div>
                      </div>
                      <div class="message-row__time">${escapeHtml(message.timeLabel)}</div>
                      <div class="message-row__preview">${escapeHtml(message.preview)}</div>
                    </li>
                  `;
                })
                .join("");
              return `
                <div class="message-group">${escapeHtml(label)}</div>
                <ul class="message-rows">${rows}</ul>
              `;
            })
            .join("");

          dom.messageList.innerHTML = markup;
        }

        function renderReadingPane() {
          const message = state.messages.find(entry => entry.id === state.selectedMessageId);
          if (!message) {
            dom.readingSubject.textContent = "Select a message";
            dom.readingDate.textContent = "Choose an email from the list to preview body copy.";
            dom.readingSender.textContent = "Reporter sandbox";
            dom.readingSenderRole.textContent = "";
            dom.readingTo.textContent = "";
            dom.readingAvatar.textContent = "--";
            dom.readingBody.innerHTML = "<p>Pick a message to load its contents.</p>";
            return;
          }

          dom.readingSubject.textContent = message.subject;
          dom.readingDate.textContent = message.fullDate;
          dom.readingSender.textContent = message.senderName;
          dom.readingSenderRole.textContent = message.senderTitle || "";
          dom.readingTo.textContent = message.toLine;
          dom.readingAvatar.textContent = initials(message.senderName);
          dom.readingBody.innerHTML = message.body.map(paragraph => `<p>${escapeHtml(paragraph)}</p>`).join("");
        }

        function renderProfile() {
          const user = getSelectedUser();
          dom.profileName.textContent = user.displayName;
          dom.profileRole.textContent = user.jobTitle || "Team member";
          dom.profileAvatar.textContent = initials(user.displayName);
        }

        function renderStatus() {
          dom.statusItems.textContent = `Items: ${state.messages.length}`;
          const user = getSelectedUser();
          const department = getDepartment(user);
          dom.statusContext.textContent = `Previewing ${user.displayName}'s ${department ? department.name : "team"} mailbox.`;
          const unread = state.messages.filter(message => message.unread).length;
          dom.inboxBadge.textContent = unread;
        }
        function setUser(userId) {
          state.selectedUserId = userId;
          state.messages = buildMailbox(getSelectedUser());
          state.selectedMessageId = state.messages[0]?.id || null;
          renderProfile();
          renderMessageList();
          renderReadingPane();
          renderStatus();
        }

        function setActiveMessage(messageId) {
          state.selectedMessageId = messageId;
          renderMessageList();
          renderReadingPane();
        }

        function applySettings() {
          document.body.classList.toggle("compact-rows", state.settings.compactRows);
          document.body.classList.toggle("hide-snippets", !state.settings.showSnippets);
          document.body.classList.toggle("focus-reading", state.settings.highlightFocused);
        }

        function openUserPicker() {
          dom.userPicker.hidden = false;
          document.body.classList.add("modal-open");
          renderUserPickerList();
          dom.userPickerFilter.value = "";
          dom.userPickerFilter.focus();
        }

        function closeUserPicker() {
          dom.userPicker.hidden = true;
          document.body.classList.remove("modal-open");
        }

        function renderUserPickerList(filterText = "") {
          const query = filterText.trim().toLowerCase();
          const filtered = allUsers.filter(user => {
            if (!query) return true;
            const department = getDepartment(user);
            return [user.displayName, user.jobTitle, department ? department.name : ""]
              .filter(Boolean)
              .join(" ")
              .toLowerCase()
              .includes(query);
          });

          if (filtered.length === 0) {
            dom.userPickerList.innerHTML = '<p class="user-picker__empty">No users found.</p>';
            return;
          }

          dom.userPickerList.innerHTML = filtered
            .sort((a, b) => a.displayName.localeCompare(b.displayName))
            .map(user => {
              const department = getDepartment(user);
              const isActive = user.id === state.selectedUserId;
              return `
                <button type="button" class="user-option${isActive ? " is-active" : ""}" data-user-id="${escapeHtml(
                  user.id
                )}">
                  <strong>${escapeHtml(user.displayName)}</strong>
                  <span>${escapeHtml(user.jobTitle || "Team member")}</span>
                  <span>${escapeHtml(department ? department.name : "Cross-functional")}</span>
                </button>
              `;
            })
            .join("");
        }

        function openSettings() {
          dom.settingsPanel.hidden = false;
          document.body.classList.add("modal-open");
          dom.settingsToggle.setAttribute("aria-expanded", "true");
          dom.settingsForm.elements.compactRows.checked = state.settings.compactRows;
          dom.settingsForm.elements.showSnippets.checked = state.settings.showSnippets;
          dom.settingsForm.elements.highlightFocused.checked = state.settings.highlightFocused;
        }

        function closeSettings() {
          dom.settingsPanel.hidden = true;
          document.body.classList.remove("modal-open");
          dom.settingsToggle.setAttribute("aria-expanded", "false");
        }

        dom.messageList.addEventListener("click", event => {
          const row = event.target.closest("[data-message-id]");
          if (!row) return;
          setActiveMessage(row.getAttribute("data-message-id"));
        });

        document.getElementById("user-picker-trigger").addEventListener("click", openUserPicker);
        dom.userPicker.addEventListener("click", event => {
          if (event.target === dom.userPicker) closeUserPicker();
        });
        dom.userPicker.querySelector("[data-close-user-picker]").addEventListener("click", closeUserPicker);
        dom.userPickerList.addEventListener("click", event => {
          const button = event.target.closest("[data-user-id]");
          if (!button) return;
          const nextId = button.getAttribute("data-user-id");
          closeUserPicker();
          setUser(nextId);
        });
        dom.userPickerFilter.addEventListener("input", event => {
          renderUserPickerList(event.target.value);
        });

        dom.settingsToggle.addEventListener("click", openSettings);
        dom.settingsPanel.addEventListener("click", event => {
          if (event.target === dom.settingsPanel) closeSettings();
        });
        dom.settingsPanel.querySelector("[data-close-settings]").addEventListener("click", closeSettings);
        dom.settingsForm.addEventListener("change", event => {
          const { name, checked } = event.target;
          if (!Object.prototype.hasOwnProperty.call(state.settings, name)) return;
          state.settings[name] = name === "showSnippets" ? checked : Boolean(checked);
          applySettings();
        });

        document.addEventListener("keydown", event => {
          if (event.key === "Escape") {
            if (!dom.userPicker.hidden) {
              closeUserPicker();
              return;
            }
            if (!dom.settingsPanel.hidden) {
              closeSettings();
            }
          }
        });

        setUser(state.selectedUserId);
        applySettings();
      })();
    </script>
  </body>
</html>
